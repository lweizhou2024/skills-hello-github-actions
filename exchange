% ScreenCapture_FullDesktop_Manual.m
% Capture the full screen on key/mouse trigger (works even if MATLAB not in front)

outputFile = 'screen_capture_manual.mp4';
videoFrameRate = 1; % playback fps

fprintf('Starting manual full-screen capture...\n');
fprintf('Click or press any key to capture a frame.\n');
fprintf('Press ESC or close control window to stop.\n');

% --- Setup video writer ---
v = VideoWriter('screen_capture_manual.avi','Motion JPEG AVI');
v.FrameRate = 1;
open(v);

% --- Create control window ---
fig = figure('Name','Screen Capture Control', ...
    'NumberTitle','off','MenuBar','none','ToolBar','none', ...
    'Color','w','Position',[200 200 420 120], ...
    'KeyPressFcn',@keyCallback, ...
    'WindowButtonDownFcn',@clickCallback, ...
    'CloseRequestFcn',@closeCallback);

uicontrol('Style','text','String',...
    'Click or press key = capture; ESC = stop.',...
    'FontSize',11,'Units','normalized','Position',[0.05 0.3 0.9 0.4]);

% --- Shared state ---
data.stop = false;
data.trigger = false;
guidata(fig, data);

frameCount = 0;

% --- Capture loop ---
while ishandle(fig)
    drawnow;
    d = guidata(fig);
    if d.stop, break; end

    if d.trigger
        d.trigger = false;
        guidata(fig, d);

        % --- Capture entire screen via .NET ---
        bounds = System.Windows.Forms.Screen.PrimaryScreen.Bounds;
        import System.Drawing.*
        bmp = Bitmap(bounds.Width, bounds.Height);
        g = Graphics.FromImage(bmp);
        g.CopyFromScreen(Point(0,0), Point(0,0), bmp.Size);
        % Convert .NET bitmap to MATLAB image
        stream = System.IO.MemoryStream();
        bmp.Save(stream, Imaging.ImageFormat.Png);
        bytes = uint8(stream.ToArray());
        frame = imdecode(bytes, 'png');

        % --- Write to video ---
        writeVideo(v, frame);
        frameCount = frameCount + 1;
        fprintf('Captured frame %d\n', frameCount);

        % Clean up .NET objects
        g.Dispose();
        bmp.Dispose();
        stream.Dispose();
    end
    pause(0.05);
end

% --- Finalize video ---
close(v);
if ishandle(fig), delete(fig); end
pause(0.5);
fprintf('âœ… Done! Saved %d frames to %s\n', frameCount, outputFile);
msgbox(sprintf('Manual capture done.\nFrames: %d\nFile: %s', ...
    frameCount, outputFile), 'Done');
load handel; sound(y, Fs);

% --- Callbacks ---
function keyCallback(src,event)
    d = guidata(src);
    if strcmp(event.Key,'escape')
        d.stop = true;
    else
        d.trigger = true;
    end
    guidata(src,d);
end

function clickCallback(src,~)
    d = guidata(src);
    d.trigger = true;
    guidata(src,d);
end

function closeCallback(src,~)
    d = guidata(src);
    d.stop = true;
    guidata(src,d);
    delete(src);
end
